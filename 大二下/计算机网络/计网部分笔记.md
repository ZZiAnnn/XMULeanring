# 计算机网络

## 01传输媒介

## 02局域异步通信

### 1.传输模式

数据通过底层介质传送的方式
串行：
![image-20230525083851810](C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230525083851810.png)

并行：多位同时传输
大多数通信系统采用串行传输：
1.串行成本低，使用的导线少，中间的电子元件价格更低；
2.并行系统要求每根导线都要刚好等长；
3.在超高传输速率情况下，并行导线之间可能因为电磁噪声造成信号干扰

异步通信模式：单工、半双工、全双工

端序：内存地址以低地址为端，网络通信以零时刻为端

### 2.RS-232C

电子工业协会(EIA)，用于计算机、调制解调器或ASCII终端之间对的串行、异步、短距离、全双工通信

电气特性：连线长度小于50英尺，电压范围在-15V~15V，负电压表示1，正电压表示0

帧格式：硬件通过配置可以控制每秒传输的确切码位数（7比特字符或8比特字符）

![image-20230525090833876](C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230525090833876.png)

## 03远距离通信

调制和解调制：调频、调幅、调相

复用和解复用：
1.频分复用
2.波分复用：应用于光纤中的频分复用技术
3.时分复用：
同步时分多路复用：
![image-20230525092106746](C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230525092106746.png)
统计时分多路复用：必须包含目的接收器的标识
![image-20230525092128627](C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230525092128627.png)
4.码分复用

## 04.可靠信道编码

## 05.分组、帧和编址

### 1.分组和交换 

**电路交换**：发送方和接收方之间建立一条通路的通信机制，保证该通路和其余的通路是分开的

* 点对点通信
* 在需要的时候建立电路，电路建立、使用和终止由分开的步骤完成
* 性能上等价于一条独立的物理通路，不受其余通信的干扰

![image-20230525092917595](C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230525092917595.png)
**分组交换**(统计时分复用)：多个来源争夺共享介质的使用

* 异步，一个发送方可以和多个接收方通信，一个接收方也可以接受来自于多个发送方的报文
* 无需建立连接，总是保持在准备的状态，可以随时发送分组
* 性能各异：可以发送的分组量和接入的设备数量有关

![image-20230525093915151](C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230525093915151.png)
## 





## 07局域网扩展设备

### 1.以太网的网络布线演变

以太网的4种不同的物理层：

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230417083128311.png" alt="image-20230417083128311" style="zoom: 50%;" />

传输速率（Mbps）+Base（基带）/Broad（宽带）+传输介质

#### (1) 原始粗缆以太网(10Base5)

通信介质：**10BASE5**(一根粗的同轴电缆)

拓扑结构：总线拓扑

* 连接到网络的每个计算机都需要收发器（ transceiver）
* 连接网卡和收发器的电缆称为连接单元接口（ Attachment Unit Interface， AUI）。
* 多路复用器允许多台计算机连接到一个单一的收发器。  

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230417083929638.png" alt="image-20230417083929638" style="zoom: 33%;" />

#### (2) 细缆以太网布线(10Base2)

传输介质：**10Base2**(同轴电缆)

拓扑结构：总线结构

* 不再使用AUI电缆来连接计算机与收发器，而是将收发器直接集成到了网络接口卡
* 直接用一条同轴电缆从一台计算机连接到另一台计算机

优点：总费用低，容易安装；不需要外部收发器，整个细网电缆可以安装在方便的通道上

缺点：网络容易故障(中间移走一台计算机或拔掉网络的一段进行重新布线的时候整个网络会停止工作)

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230417114924456.png" alt="image-20230417114924456" style="zoom: 50%;" />

#### (3)双绞线以太网

传输介质：**10Base-T**(双绞线)

拓扑结构：**星型总线**(物理上星型结构，逻辑上总线结构)

* 使用以太网集线器，其中的电子部件仿真了物理电缆的特性，系统运行和传统以太网一样(CSMA/CD)
* 计算机和集线器之间使用带**RJ-45**连接器的双绞线布线：分为直连线(连接计算机与交互机)，交叉型(用来连接两台交换机)

保留之前的帧格式，软件不区分是粗缆以太网、细缆以太网还是双绞线以太网，由计算机上的网络接口处理所有细节和隐蔽任何差异

**拓扑悖论**：

第三代双绞线以太网10BaseT布线形成以集线器为中心的星型拓扑结构

但是集线器仿真了一条物理电缆的特性，所有计算机共享一个通信介质，像总线结构一样工作

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230417085310590.png" alt="image-20230417085310590" style="zoom: 20%;" />

#### (4) 光纤以太网(10Base-F)

传输介质：光纤

## 08 远距离通信技术

数字化：将模拟信号转换成数字信号的过程

奈奎斯特采样定理：当采样频率$fs.max$大于信号中最高频率$fmax$的2倍时$(fs.max>2fmax)$，采样之后的数字信号能完整地保留了原始信号中的信息

脉冲编码调制(PCM)：采样信号间隔为$125 \mu s$,并将每个样本分为$0-255$的整数

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230417101741769.png" alt="image-20230417101741769" style="zoom: 50%;" />

## 09 广域网技术和协议分层

### 1.广域网技术与路由

#### (1)分组交换机

网络技术分为三大类：局域网(LAN)，城域网(MAN)，广域网(WAN)

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230418105025491.png" alt="image-20230418105025491" style="zoom: 50%;" />

解决方案：高层“分组交换机”，采用存储/转发模式

* 中央处理器：转发到下一站
* 存储器：帧，转发信息  

**传统分组交换机**：

​		由一个小型计算机系统构成，包括处理器、存储器和用于收发分组的I/O设备（存在两种I/O设备，第一种可以高速运行，用于连接本地交换机和数字电路，第二种以较低的速度运行，用于本地交换机和个人计算机的连接）

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230418105555277.png" alt="image-20230418105555277" style="zoom: 80%;" />

**LAN技术出现后的分组交换机**：

大多数WAN会把一个分组交换机分为两个部分：

* 第二层交换机，发挥交换作用，即实现站内计算机之间的连接
* 路由器：发挥路由功能，提供通向另一个站点的数据线路连接

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230418114543264.png" alt="image-20230418114543264" style="zoom: 33%;" />

**交换机的机制**：存储转发  

* 存储： 存储操作发生于分组到达时，交换机中的I/O硬件将数据包的副本缓存在存储器中
* 转发：转发操作发生于分组到达并等待在内存中，处理器检查包，解析目的地址，将数据包发送到通向目的地的I/O接口上  

**广域网编址方案**：分层编址（站点号+主机号）

* 第一部分标识分组交换机：每个分组交换机被分配一个唯一的号码
* 第二部分标识特定计算机  

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230418110258542.png" alt="image-20230418110258542" style="zoom:80%;" />

**广域网寻址方案**：下一跳转发(层次寻址)

交换机检查数据包的目的地址，提取交换机号

* 本地：交换机将数据包直接发送到计算机，即如果目的地址中的数字与分组交换机自身的ID相同，则该分组将用于本地分组交换机上的计算机
* 否则：数据包必须转发到另一个交换机

​		实现了只基于交换机ID转发，意味着交换机只需要知道在哪个链路传出即可，交换机不需要保有所有可达的计算机的完整信息，也没有一个交换机需要计算整个路由，交换机只需要计算数据包的下一跳  

优点：

* 转发表所需的计算时间减少：因为转发表可以被组织成一个数组，使用索引，而不是搜索
* 转发表所需的存储空间减少： 包含每个包交换的一个条目，而不是每个目标计算机的一个条目表，存储空间可能大大减少。  

**下一跳转发实现**：转发表

存储目的交换机和对应下一跳的表  ，这里“转发表”本应成为路由表，将数据包转发到下一跳的过程称为路由

需要列出所有连接在本分组交换机上的可能的分组交换机，并且为每一个分组交换机给出下一跳

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230418111451242.png" alt="image-20230418111451242" style="zoom:80%;" />

**源独立**：

​		下一跳转发即不依赖于数据分组的原始源数据，也不依赖于分组到达前的特定路径，下一跳仅取决于数据分组的目的地
​		源独立令计算机网络中的转发机制显得紧凑和高效  

#### (2) 路由表

**路由表的要求：**

1. 全局通信，即每个交换机的转发表必须包含到达所有可能目的地址的有效的下一跳路由
2. 最优路径：每个交换机中，转发表内对于一个给定目的地的下一跳值，必须是指向目的地的最短路径.

**路由表的计算**：

1. 静态路由：交换机启动时，计算并安装路由；路由不会改变  ，多用于主机内部的路由表（下一跳设置为本网上的路由器）

   优点：简单和低开销,不需要消耗CPU时钟周期和带宽	缺点：缺乏灵活性，当通信中断时，无法更改静态路由  

2. 动态路由（大多数广域网使用）：交换机启动，生成初始路由表；网络改变时，程序改变表。大型网络的设计留有用于处理偶尔的硬件故障的冗余。

**路由表制作(图论)**：

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230418115216259.png" alt="image-20230418115216259" style="zoom:50%;" />

**默认路径**：

* 一种允许转发表中的单个条目替换具有相同下一跳值的长条目列表的机制。
* 在一个转发表中，只允许存在一个默认表项， 其具有最低的优先级 
* 仅当多个目的地具有相同的下一跳值时才存在默认条目  

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230418122923415.png" alt="image-20230418122923415" style="zoom: 50%;" />

**分布式路径计算**

广域网需要进行分布式路由计算，即不是一个集中的程序计算所有最短路径，而是每个交换机必须计算自己的转发表，本地所有交换机必须参与分布式路由计算  

两种计算方法

1.**链路状态路由(LSR)**  



2.**距离矢量路由(DVR)**  

### 2.协议与分层

**协议**（ protocol ），网络协议：参与通信的各方必须在交换消息时使用的一组指定的消息格式和每个消息所需的适当的**行动规则**。实施这些规则的软件称为协议软件（ protocol software ）。

**分层模型**（ layering model ）：将通信问题划分成子块，为每个子块设计一个单独的协议，使得每个协议更容易设计，分析，实现和测试，每个协议应该处理其他协议无法处理的通信问题的一部分。  

协议的设计为完整的、相互配合的集合，称为**系列（ suites）或族（family）**。

* 不是孤立地创建每个协议
* 协议组合应处理所有可能的硬件故障或其他异常情况。
*  在一个系列中的每个协议解决了通信问题的一部分，他们
  一起解决了整个通信问题。  

#### 两种国际标准
只要遵循标准，一个系统就可以和位于世界上任何地方的、也遵循这同一标准的任何系统进行通信。

* 法律上的(de jure)国际标准 ： ISO/OSI 模型
* 事实上的(de facto)标准： TCP/IP 模型  

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230418131517617.png" alt="image-20230418131517617" style="zoom: 50%;" />

**分层的好处**：

* 各层之间是独立的，灵活性好，结构上可分割开。
* 易于实现和维护。
*  能促进标准化工作。

**层数多少要适当**：

* 若层数太少，就会使每一层的协议太复杂。
* 层数太多又会在描述和综合各层功能的系统工程任务时遇到较多的困难 

####  1. OSI/ISO参考模型 

开放系统互连七层参考模型(Open Systems Interconnection Reference Model，OSI ) 

由ISO(国际标准化组织)和ITU-T(国际电信联盟，电信标准化组)联合推出

1. 物理层：完成对bit和载波之间的转换 ，处理与物理传输介质相关的接口

2. 数据链路层

   介质访问控制子层(MAC)：解决广播型网络中多用户竞争
   逻辑链路控制子层(LLC)： 链路差错控制、帧校验；链路流量控制  

3. 网络层：主机到主机间的通信，路由寻径，流量控制、拥塞控制  

4. 传输层：进程间端到端的通信， 提供传输的可靠性  

5. 会话层：会话建立、撤销，传输同步，面向连接的交互活动管理：口令认证，数据传输规范  

6. 表示层：信息压缩，信息加密、解密，与标准格式的转换  

7. 应用层：提供最通用的应用程序（电子邮件、 BBS、 Web、文件传输等），完成用户信息或者软件转换信息的交互  

**在市场化方面 OSI 失败的原因**

* 专家们在完成 OSI 标准时没有商业驱动力；
*  定周期太长，按 OSI 标准生产的设备无法及时进入市场；
*  层次划分不合理，有些功能在多个层次中重复出现  

#### 2.TCP/IP协议族  

（ 1）网络接口层：最下面的网络接口层并没有具体内容；
（ 2）网际层；（ 3）传输层；（ 4）应用层

不足:网际层之下的网络接口层较为笼统，没有具体内容  

#### 3.五层协议体系结构

折中综合 OSI 和 TCP/IP 的优点 

1. 应用层(application layer)
2. 传输层(transport layer)
3.  网络层(network layer)
4.  数据链路层(data link layer)
5.  物理层(physical layer)  

分层的数据结构

* 数据头：由协议加进去的附加信息，是一个抽象的概念，不一定在开始的位置。发送计算机上的给定层中的软件向传出数据添加信息，接收计算机上同一层的软件使用附加信息处理输入的数据  
* 有效数据

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230418133111720.png" alt="image-20230418133111720" style="zoom:33%;" />

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230418133208916.png" alt="image-20230418133208916" style="zoom: 33%;" />

## 10 IP标志和报文

### 1.路由器

世界互联的困难（每一个网络是一个孤岛）：

1. 电气不兼容
2. 地址格式不兼容=>IP地址
3. 包不兼容=>IP包

**全局服务（通用服务）**：任意两台计算机之间能够相互通信

* 由此产生的连通物理网络的系统称为互联网（internet-work或 internet ）
*  当前正在使用的互联网络：因特网（  Internet ）  

**路由**：为单网络中、多网络间或跨多网络（两个局域网、局域网和广域网、两个广域网）的流量**选择路径的过程**  

* 狭义：通常指IP路由
* 广义：路由在许多类型网络中都会出现，比如电路交换网络中的公共交换电话网(PSTN)，计算机网络中的因特网等

**路由和桥接的区别**：

* 路由是大型网络中的结构化寻址
* 桥接是局域网中的非结构化寻址

**路由器**：计算机网络之间**转发数据包**的网络设备  

**网关** ：允许数据从一个离散网络流向另一个离散网络的网络硬件  

**虚拟网络**：

1. 互联网提供了表面上单一的无缝通信系统，可以提供全局服务(每台计算机只分配一个地址任何计算机都能发送分组到其他计算机)

2. 硬件和软件的结合提供了一个统一的网络系统的错觉  

   * 互联网软件隐藏细节物理网络连接物理地址路由信息

   *  应用不需要知道底层物理硬件或路由器的存在  

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230417111954967.png" alt="image-20230417111954967" style="zoom: 50%;" />

### 2.互联网协议地址

#### (1) 虚拟互联网的地址

地址实现从硬件到软件的转变

因特网协议要达到的要求

1. 必须屏蔽物理网络的具体细节，并提供一个单一的、大型的虚拟网络设施（与物理层独立）
2. 允许计算机发送和接受数据分组
3. 所有主机必须使用统一的编址方案，并且每个地址必须是唯一的

​		因特网和物理网的区别：因特网仅仅是由设计者想象出来的抽象物，完全由协议软件产生，设计者可以自由地选择独立于底层硬件细节的地址、分组格式和传递技术。

#### (2) IPv4地址的分配和总格式

地址所有权： 互联网名称与数字地址分配公司（ ICANN）处理地址分配和裁决争端

* ICANN不直接分配具体前缀，而是授权**注册商**分配**前缀**
* 注册商向主要的ISP提供大地址块，之后再由他们向小的ISP提供地址块
* ISP(网络业务提供商)向用户提供**地址获取前缀**，用户再将这些前缀用于各自的网络，
* 对于公司或个人想要获取网络前缀，应该联系ISP

IP地址编址：

1. 用点分十进制计数法表示，每8位作为无符号十进制值（ 0~255）并用点分隔  
2. 是全球位移的**32**位数字，分为两个部分：
   * 网络号，标识主机附加的物理网络，全球协调
   *  主机号，标识网络上的特定计算机，局域网内协调  

#### (3) IPv4具体格式演化

##### I.分类IP地址(1981-1993)

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230417190308069.png" alt="image-20230417190308069" style="zoom: 33%;" />

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230417185823513.png" alt="image-20230417185823513" style="zoom: 50%;" />

**D类地址即可作为源地址，也可以作为目的地址**

**255.255.255.255既是有限广播地址又是保留地址，用法不冲突需要根据实际情况正确选择**

特殊的IP地址：

* 主机号全0代表网络，主机号全1代表广播
*  一些IP地址是保留的，不分配给主机  

| 特殊地址     | 规则                 |                                                        |
| ------------ | -------------------- | ------------------------------------------------------ |
| 网络地址     | 主机号全0            | 不能作为源地址，也能不作为目的地址                     |
| 直接广播地址 | 主机号全1            | 只能用于目的地址                                       |
| 有限广播地址 | 255.255.255.255 全 1 | 只能用于目的地址                                       |
| 本机地址     | 全 0                 | 用作源地址（很少用与目的地址），不能用于多播或广播地址 |
| 回送地址     | 127.0.0.0/8          | 回送地址，可以不通过网络                               |

有限广播和直接广播的区别：

* 有限广播地址不需要知道网络号，直接在本网段内进行广播
* 而直接广播需要知道网段，在指定网段下进行广播

##### II.子网划分（ 1985～）  

​		子网编址和无类编址关系密切，子网编址适用于连接到因特网的大机构，而无类编址推广到了整个因特网

* 划分子网是单位内部的事情，单位对外仍然表现为没有划分子网的网络。
*  从其他网络发送给本单位某个主机的 IP 数据报，仍
  根据其目的网络号，找到本单位的路由器。
* 此路由器收到数据报后，提取子网号找到目的子网。
* 最后将 IP 数据报直接交付目的主机。  

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230427103828774.png" alt="image-20230427103828774" style="zoom:50%;" />

**地址掩码**：

​		由连续的`N`位1连续的`32-N`位0构成，共有**33**种

​		作用：获取网络地址

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230427103126647.png" alt="image-20230427103126647" style="zoom: 50%;" />

##### III.无分类IP地址（ 1993～）  

无类域间路由（CIDR）

表示方式：`ddd.ddd.ddd.ddd/m`（m为掩码中1的个数）

对主机进行分配时需要排除主机号全1和全0的两个特殊IP地址(RFC 1878废止，现代软件可以能够利用所有可定义的网络)

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230427104213696.png" alt="image-20230427104213696" style="zoom: 33%;" />

### 3.因特网的结构和协议

底层的硬件不能识别因特网包格式，因特网内的主机和路由器都包含了解因特网数据报的协议软件

**IP数据报：**

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230427104515932.png" alt="image-20230427104515932" style="zoom:50%;" />

IP报文头格式的组成（基本长度： 20B）
版本： 4bits， 取值： 4或6
报头长度： 4bits，单位为4Bytes
服务类型： 8bits，未实际使用
报文总长度： 16bits，单位为字节
标识： 16bits， IP软件在存储器中的计数器在产生一个数据报后自增 1，并将值赋给标识字段。标识在分片时复制。
分片标志： 3bits，高到低位：无意义、不分片、还有分片  

片偏移： 13bits，分片在原始报文的位置，单位为**8Bytes**
生存时间（ TTL） ： 8bits，单位为秒，路由器减去在其环节所消耗时间，直至零丢弃。
协议类型： 8bits，可能的取值有： ICMP、 IGMP、 TCP、UDP、 OSPF等，用于将数据交给第四层的哪个软件。
报头校验和： 16bits，检验报头的完整性，不含数据部分 

源IP地址： 32bits
目标IP地址： 32bits
选项内容： 1～40bits （可变长度），用来支持排错、测量以及安全等措施。
填充部分：（根据选项部分改变），为了使得报文头部是4Bytes的整数倍   

### 4.IP数据报转发

**路由表**：
目标网络号、子网掩码、下一跳（直接传送标志、子网IP地址）
 默认路由：0.0.0.0/0，对应掩码0.0.0.0

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230427105220626.png" alt="image-20230427105220626" style="zoom:50%;" />

**数据转发**：

1. 获得IP报文的目标IP地址D
2. 用D顺序逐条匹配路由表各个条目$T_1， T_2， T_3,$…
3. 如果$D \& T_i ^{(m)}==T_i^{(d)}$,则下一跳为$T_i^{(n)}$

$D$：路由表中第 $i$ 条目标子网网络号
$T_i ^{(m)}$：路由表中第 $i$ 条目标子网掩码
$T_i ^{(n)}$：路由表中第 $i$ 条下一跳IP地址

**最长前缀匹配**：

多个表项匹配某个目的地可能会导致歧义性，即可能不止有一个$i$使得$D \& T_i ^{(m)}==T_i^{(d)}$成立，这个时候优先选择前缀最长的表项

## 11.IP支撑协议和IPv6

### 1.Internet控制报文协议（ICMP）

​	IP虽然是一种尽力而为的通信方式，会发生丢失、重复、延迟和乱序到达，但是IP会试图避免错误并在错误发生时报告问题

Internet 控制报文协议 （ ICMP ，Internet Control Message Protocol）
**目的**：提高 IP 数据报交付成功的机会。
**协议层**：网络层
**机制**：主机或路由器报告差错情况和提供有关异常情况的报告。
**发送方式**：作为 IP 层数据报的数据，加上数据报的首部，组成 IP 数据报发送出去。  

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230425174217640.png" alt="image-20230425174217640" style="zoom:50%;" />

**报文格式**：

ICMP消息被放置在IP数据报的载荷部分，该数据报会被正常转发，整个数据报被封装在一个数据帧中传输

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230425174345905.png" alt="image-20230425174345905" style="zoom: 50%;" />

不应发送 ICMP 差错报告报文的几种情况：

1. 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。
2. 对第一个分片的数据报片的所有后续数据报片都不发送ICMP 差错报告报文。
3. 对具有多播地址的数据报都不发送 ICMP 差错报告报文。
4. 对具有特殊地址（如127.0.0.0 或 0.0.0.0）的数据报不发送
   ICMP 差错报告报文。  

**应用举例**：

1. ping(因特网包探索器)可以利用echo请求和echo响应来测试连通性，echo响应会携带与请求相同的数据，因此ping可以通过向远端主机发送一个请求，之后等待回应确定该主机可达或者在超过一定时间后说明该主机不可达，ping是应用层直接使用网络层ICMP的例子，没用通过传输层的TCP或UDP
2. tracert（跟踪路由）可以利用Echo请求和Echo响应来得到网络中的一条路径：traceroute应用发送一系列TTL为1、2、3、4...的echo请求，这些消息会在对应跳数后的路由器处超时，对应的路由器会向traceroute程序返回一个ICMP超时错误消息，最后也会从最终目的主机收到一个echo响应，以此能得出一条网络路径

### 2.地址解析协议（ARP）

**地址解析**：将IP地址解析为MAC地址（IP是虚拟地址，数据链路层需要的是物理地址，为了数据传输必须进行转换）

![image-20230425180446622](C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230425180446622.png)

**解析过程**：

假设W、Y连接在同一个以太网

1. W广播：正在查找 IPv4 为 X 的主机的 MAC 地址
2. Y回应：本机是 IPv4 为Y的主机，本机的 MAC 地址为 M

![image-20230425181000568](C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230425181000568.png)

**消息格式**：
		ARP报文格式对任何协议和硬件地址都是充分通用的，但ARP几乎总是应用于IP地址(32位)和以太网地址(48位)绑定

**硬件地址类型**：以太网对应为1
**协议地址类型**：IPv4对应的值为 0x0800
**操作**：16位长，指定报文是一个请求报文(值为1)还是一个应答报文(值为2)

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230427081828594.png" alt="image-20230427081828594" style="zoom:67%;" />

**ARP封装**

​		类型域指明帧中含有一个ARP报文，以太网用帧类型0x0806来表示ARP报文，请求和响应应使用相同的类型值，所以当接收方需要判断ARP是请求还是响应时需要利用ARP中的“操作”域，不能直接根据类型域判断

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230427082359884.png" alt="image-20230427082359884" style="zoom:67%;" />

**ARP缓存**：
**目的**：减少网络通信量，避免每次传输数据都要进行ARP请求和响应的发送

**流程**：
		ARP会从响应报文中提取有关信息，并将绑定表存储在cache中

执行地址绑定

1. 当绑定信息已经存在cache中时，直接使用这个绑定信息而无须再发送一个请求
2. 当绑定信息不存在于cache中时，ARP广播一个请求并等待响应，然后更新cache，并用所得绑定信息继续工作

处理输入报文

1. 接收方从ARP报文中提取发送方的地址绑定信息，并检查cache中是否存在发送方的地址，如果已经存在则更新cache中的内容，该更新方式应对了发送方硬件地址发生变化的情况
2. 检查ARP报文中的“操作”域以确定是一个请求报文还是响应报文
   **请求报文**：接收方比较“目标协议地址”域和本地协议地址，确定本机是否为请求的目标，如果是则根据请求报文里的信息和自己的物理地址发回一个响应报文
   **响应报文**：说明接收方一定发送过一个请求报文，会将响应结果的对应数据装入cache中

两个注意点：

1. 计算机通信大概率是双向通信业务，因此接收方取出发送方地址绑定信息并存储会优化ARP的性能，避免了后续原接收方要重新发送ARP请求
2. 地址表存储需要内存，只有是ARP请求目标的计算机才会向它的cache添加绑定信息，而其他收到信息的计算机不会存储

### 3.动态主机配置协议（DHCP）



### 4.网络地址转换(NAT)

​		IPv4地址随着因特网发展变得紧张，但是端口号并不紧张，因此希望可以实现一个站点内有多台计算机共享一个全球有效的IP地址

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230427092646978.png" alt="image-20230427092646978" style="zoom: 50%;" />

**寻址机制**：一个NAT设备不能将一个指定的IP分配给多个主机，否则会引起地址冲突而导致通信失败。因此指定网络上的每台计算机都要分配一个唯一的IP地址。

NAT利用两种地址解决这个问题：

1. NAT设备自身利用DHCP从用户的ISP那里获取一个全球有效的IP地址
2. 当站点内主机连接网络时运行DHCP，NAT设备回应这个DHCP并分配一个唯一的私有地址（不可路由地址）

**私有IP**：私有地址在全球因特网上是无效的，因特网上的路由器已经被配置为拒绝路由含有不可路由的数据报。因此私有地址只能在站内使用。

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230427095135712.png" alt="image-20230427095135712" style="zoom:33%;" />

**地址转换**：NAT需要实现站点接受和发送数据时实现全球有效地址和私有地址的转换

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230427095322426.png" alt="image-20230427095322426" style="zoom:50%;" />

**传输层的NAT(NAPT)**

NAPT:网络地址与端口转换

背景：当站点内有多个计算机与相同因特网目的地发起通信或者一台主机内多个应用进程跟因特网上的不同目的地进行通信时基础转换方法就会失效

解决方案：协议端口号，NAPT从可用端口池中动态分配端口号并建立和私有地址的映射

（计算机进程的协议端口号不是随机分配的，由互联网号码分配机构（IANA）分配并维护一个端口号序列，但是NAPT可以将源端口号修改为一个未被占用的端口号）

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230427101359646.png" alt="image-20230427101359646" style="zoom:50%;" />

## 12.传输控制协议

​		网络层提供了主机与主机之间的通信，但是IP地址无法区分指定主机上运行的多个应用程序，传输层协议（端到端协议）允许将单个应用程序看成通信的端点，实现端到端的通信

### 1.传输层概述

主机上多个进程共享主机的网络连接进行通信

* 唯一标识主机和主机上的连接： IP地址
* 唯一标识进程：端口号
*  网络通信本质上是两个进程间的通信，不是主机间通信

 传输层的作用：提供了进程间的复用和解复用

* 传输层隐藏了硬件拓扑、路由细节等，使应用程序直接调
  用其接口，建立一条虚拟的端到端的通信信道  

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230424084037954.png" alt="image-20230424084037954" style="zoom:50%;" />

协议端口：

​		传输层协议需要跨越异构的计算机，这些计算机对于相同的应用进程可能有不同的表示方法

* 软件端口，有别于交换机上的硬件端口
* 端口号（ 16bits），范围： 0～65535，
* 作用：用于标识本机的不同进程

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230424083957241.png" alt="image-20230424083957241" style="zoom: 50%;" />

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230424084132190.png" alt="image-20230424084132190" style="zoom: 50%;" />

### 2.用户数据协议（UDP）

 **作用**：不可靠但轻快的传输

* 在 IP 服务之上，增加端口的功能和差错检测的功能，UDP校验和是可选的（ 0表示不计算）
*  UDP 消息可以丢失、重复、延迟、乱序、损坏  

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230424084436384.png" alt="image-20230424084436384" style="zoom:50%;" />

**分组结构**：

源端口：16bits 		目的端口：16bits

数据报文长度：最小为8 Byte（只有头部），可以任意长，但为了避免IP（MTU）对其切片，会选择1400或1500字节大小的报文长度（因特网的绝大多数底层网络都支持1500字节的MTU）

校验和：不校正，发生错误就丢弃数据报，可以选择，不启用校验和时置为全0

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230424091735362.png" alt="image-20230424091735362" style="zoom:50%;" />

伪头部：

​		UDP 头部省略了源和目的 IP 地址，会使 UDP 报文更短小有效，但是也会存在引起差错的可能（比如 IP 出现功能性障碍将 UDP 报文传输到了错误的目的地），因此引入UDP伪头部

​		伪头部不是UDP真正的头部，只在计算校验和时用到，既不向下传送也不向上递交，只是为了计算校验和

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230424092417298.png" alt="image-20230424092417298" style="zoom: 50%;" />

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230424093604149.png" alt="image-20230424093604149" style="zoom: 33%;" />

**特点**：

|     特点     |                             解释                             |
| :----------: | :----------------------------------------------------------: |
|    端到端    |    是一个传输协议，能区分运行在给定计算机上的多个应用进程    |
|    无连接    | 不需要预先建立通信，在通信结束后也无须通知网络，通信业务仅由传输的数据报本身构成，因此传输开销极低 |
|   面向报文   | 将数据放到一个单独的报文中来传输，不会将报文分割或者组合，当UDP报文超过MTU时，IP会对数据报切片，会降低效率 |
|   尽力而为   | 报文会发生丢失、重复、延迟、乱序以及损坏，要求程序对这些问题本身有很高的容错率或者采用附加的措施来检测和纠正这些问题（非常适合多媒体通信比如语音、视频等实时应用的要求） |
|   任意交互   | 支持一对一、一对多、多对一和多对多的通信交互方式，使用了IP多播（或IPv4广播）机制来传输，而不是重复发给多个接收方 |
| 操作系统无关 | 定义了协议端口号，独立于底层的操作系统，每台实现UDP计算机都要实现协议端口号与操作系统所用程序标识符之间的映射关系 |

补充：

​		连接：是指状态（变量的保持），例如在TCP协议中通信双方保持序列号等变量不变，而不是指对网络的保持

​		尽力交付：还指UDP不使用拥塞控制机制，即不判断网络产生拥塞，不调节发送速率

**应用场景**：

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230424091619052.png" alt="image-20230424091619052" style="zoom: 50%;" />

### 3.传输控制协议（TCP）（谢希仁）

IP 协议面临的问题：丢包、重复、乱序、数据损坏等。
部分程序需要可靠的传输：

* 传输信道不发生差错，如果出错要“抛出异常”
* 不管多快的速度发送数据，接收端都来得及处理  

## 13.因特网路由协议

### 1.路由协议的基本概念

**静态路由**：多用于主机，特别是主机只有一个网络连接且只有一个路由器将该网络连接到因特网的情况下，系统运行时操作系统从**硬盘**中读取IP地址、子网掩码和网关，之后构建路由表存储到内存中

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230426165638660.png" alt="image-20230426165638660" style="zoom:25%;" />

**动态路由**：能较好适应网络状态的变化，但是实现复杂，在全球前提下路由业务量会过于庞大，需要使用**分级的路由层次结构**

### 2.自治系统

**定义**：自治系统是在单一的技术管理下的**一组路由器**
**域内路由选择**：使用一种 AS 内部的路由选择协议和共同度量以确定分组在该 AS 内的路由(尽管一个 AS 使用了多种内部路由选择协议和度量，但重要的是一个 AS 对其他 AS表现出的是一个单一的和一致的路由选择策略)。
**域间路由选择**：使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230508083252978.png" alt="image-20230508083252978" style="zoom:50%;" />

**内部网关协议**(Interior Gateway Protocol,IGP):在一个自治系统内部使用的路由选择协议(RIP 和 OSPF 协议)。
**外部网关协议**(External Gateway Protocol,EGP):自治系统边界网关使用的路由选择协议(BGP-4)    

### 3.路由信息协议(RIP)

**工作原理**：分布式的基于**距离向量**的路由选择协议(网络中每个路由器维护从自己到其它目的网络的距离记录)  

**算法基础**：Bellman-Ford算法

* 仅和相邻路由器交换信息
* 交换的信息是自己的路由表
* 按固定间隔时间交换路由信息  

**特点**：

* 自治系统范围内的路由
* 采用跳数度量
* 不可靠的传输，使用UDP在路由器之间传输报文
* 采用广播或多播传递
* 支持IPv4 CIDR和子网划分
* 支持默认路径传播
* 距离向量算法
* 主机被动模式：RIP允许主机被动听取和更新转发表
* 可以扩展为IPv6

**报文格式**

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230508084711598.png" alt="image-20230508084711598" style="zoom: 33%;" />

地址族标识符字段：标志所使用的地址协议。
路由标记：填入自治系统的号码，考虑RIP可能收到本自治系统以外的路由选择信息  

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230508085648655.png" alt="image-20230508085648655"  />                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              

**优点**：实现简单，开销较小
**缺点**：限制了网络的规模，最大距离为 15（ 16 表示不可达）;当网络出现故障时，要经过比较长的时间才能将此信息传送到所有的路由器;路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加  

### 4.开放最短路径优先算法(OSPF)

Open Shortest Path First， OSPF  
开放： 不受某一家厂商控制，而是公开发表的  
算法基础：Dijkstra算法

特点：

* 自治系统内部的路由，支持CIDR
* 收验证的报文交换
* 支持路径导入：允许路由器引入通过其他手段(BGP等)学习到的路径
* 分布式的**链路状态**协议
* 支持度量：允许管理员对每条路径赋予成本参数
* 支持多接入式网络：只指定一个路由器在网络上广播来优化路由算法

为了使 OSPF 能够用于规模很大的网络， OSPF 将一个自治系统再划分为若干个更小的范围， 叫作区域 ，每一个区域都有一个 32 位的区域标识符（用点分十进制表示）  

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230508091541680.png" alt="image-20230508091541680" style="zoom: 33%;" />

OSPF 使用层次结构的区域划分。在上层的区域叫作主干区域(backbone area)。主干区域的标识符规定为0.0.0.0。主干区域的作用是连通其他在下层的区域  

OSPF不使用UDP而是直接使用IP数据报，数据报的长度很短，减少路由信息的通信量并且可以避免分片传送

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230508091711839.png" alt="image-20230508091711839" style="zoom: 33%;" />

使用可靠的洪泛算法（接收方发送确认）

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230508091926569.png" alt="image-20230508091926569" style="zoom:33%;" />

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230508091939272.png" alt="image-20230508091939272" style="zoom: 33%;" />

### 5.边界网关协议

外部网关协议

BGP特点：

* BGP寻找的只是到达目的网络且比较好的路由而不是最佳路由
* 可靠的传输，使用TCP协议

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230508092820914.png" alt="image-20230508092820914" style="zoom: 33%;" />

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230508093211266.png" alt="image-20230508093211266" style="zoom: 33%;" />

## 14.客户服务器模式和套接字API

### 1.客户端和服务器端

### 3.Socket API

![image-20230511081245585](C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230511081245585.png)

<img src="C:\Users\26401\AppData\Roaming\Typora\typora-user-images\image-20230511081324841.png" alt="image-20230511081324841" style="zoom:67%;" />

## 17.文件传输

### 1.FTP协议

基于流模式(TCP)，一个FTP的服务器进程由两大部分组成：

* 一个主进程，负责接受新的请求
* 若干个从属进程，负责处理单个请求

FTP 使用2个端口号，数据连接与控制连接不会混乱。
‒ 端口21：控制连接，当客户软件向服务器软件发出建立连接请求时，寻找连接服务器软件的21号端口，同时还告诉服务器软件自己的另一端口号，用于建立数据传送连接。
‒ 端口20：数据连接，接着，服务器软件用自己传送数据的20号端口与客户软件所提供的端口号码建立数据传送连接  
响应：登录成功203，登录失败530

## 2.TFTP协议

简单文件传输协议，使用UDP服务，端口号为69
